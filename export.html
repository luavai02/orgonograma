<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Organograma Funcional – Exportação</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body {
    margin: 0;
    padding: 20px;
    font-family: Arial, sans-serif;
    background: #ffffff;
  }

  h1 {
    text-align: center;
    color: #0b2b45;
    margin-bottom: 10px;
  }

  .acoes {
    text-align: center;
    margin-bottom: 20px;
  }

  button {
    background: #0b5ed7;
    color: #fff;
    border: none;
    padding: 10px 18px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
  }

  .organograma {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 40px;
  }

  /* Caixa da FUNÇÃO */
  .funcao {
    border: 2px solid #0b5ed7;
    border-radius: 10px;
    padding: 10px 16px;
    font-weight: bold;
    text-align: center;
    min-width: 220px;
    background: #f0f6ff;
  }

  /* Linha vertical */
  .linha {
    width: 2px;
    height: 30px;
    background: #0b5ed7;
    margin: 0 auto;
  }

  /* Pessoas */
  .pessoas {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    max-width: 1000px;
  }

  .pessoa {
    border: 1px solid #0dcaf0;
    border-radius: 8px;
    padding: 6px 10px;
    font-size: 12px;
    font-weight: bold;
    background: #e6fbff;
  }

  .vazio {
    font-style: italic;
    color: #777;
    font-size: 12px;
  }

  /* ====== IMPRESSÃO ====== */
  @media print {
    .acoes {
      display: none;
    }

    @page {
      size: A4 landscape;
      margin: 15mm;
    }
  }
</style>
</head>

<body>

<h1>Organograma Funcional</h1>

<div class="acoes">
  <button onclick="window.print()">Exportar para PDF</button>
</div>

<div id="organograma" class="organograma"></div>

<script>
  /* ============================
     URL DO APPS SCRIPT (JSONP)
  ============================ */
  const BASE =
    "https://script.google.com/macros/s/AKfycbyigyFcP5TxvuawbFkbdc7H2PyRhITazUHLMn2vcaWyea5wL6b5RXnFlWQC1F-bTnBVbg/exec";

  // Lê o filtro de posto vindo da URL
  // ex: export.html?posto=SD
  const params = new URLSearchParams(window.location.search);
  const POSTO_FILTRO = params.get("posto") || "TODOS";

  const DATA_URL = BASE + "?mode=data&callback=cb&_=" + Date.now();

  function cb(payload) {
    montar(payload.hierarchy, payload.people);
  }

  function montar(hierarchy, people) {
    const container = document.getElementById("organograma");
    container.innerHTML = "";

    hierarchy.forEach(h => {

      let pessoasFunc = people.filter(p => p.func === h.func);

      // respeita filtro
      if (POSTO_FILTRO !== "TODOS") {
        pessoasFunc = pessoasFunc.filter(p => p.posto === POSTO_FILTRO);
      }

      // bloco da função
      const blocoFunc = document.createElement("div");
      blocoFunc.className = "funcao";
      blocoFunc.textContent = "FUNÇÃO: " + h.func;

      container.appendChild(blocoFunc);

      // linha
      const linha = document.createElement("div");
      linha.className = "linha";
      container.appendChild(linha);

      // pessoas
      const pessoasDiv = document.createElement("div");
      pessoasDiv.className = "pessoas";

      if (pessoasFunc.length === 0) {
        const vazio = document.createElement("div");
        vazio.className = "vazio";
        vazio.textContent = "Sem pessoas cadastradas";
        pessoasDiv.appendChild(vazio);
      } else {
        pessoasFunc.forEach(p => {
          const card = document.createElement("div");
          card.className = "pessoa";
          card.textContent = `${p.posto} - ${p.nome}`;
          pessoasDiv.appendChild(card);
        });
      }

      container.appendChild(pessoasDiv);
    });
  }

  // JSONP
  const s = document.createElement("script");
  s.src = DATA_URL;
  document.head.appendChild(s);
</script>

</body>
</html>
