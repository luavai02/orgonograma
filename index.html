<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Organograma Funcional</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  :root{
    --bg:#f4f6f9;
    --card:#ffffff;
    --primary:#0b5ed7;
    --accent:#0dcaf0;
    --text:#0b2b45;
    --muted:#6b7280;
    --chipBg:#e7f8fd;
    --chipBorder:#bfeef7;
  }

  body {
    margin: 0;
    padding: 20px;
    font-family: Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
  }

  h1 {
    color: var(--text);
    margin-bottom: 6px;
  }

  #status {
    font-weight: bold;
    margin-bottom: 15px;
  }

  .topo-acoes {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 25px;
    flex-wrap: wrap;
  }

  select, button {
    padding: 9px 14px;
    border-radius: 10px;
    border: none;
    font-weight: bold;
    cursor: pointer;
  }

  select {
    border: 1px solid #cfd6e4;
    background: #fff;
  }

  button {
    background: var(--primary);
    color: #fff;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 6px 16px rgba(11,94,215,0.18);
  }

  button:hover {
    background: #094bb0;
  }

  .funcao {
    background: var(--card);
    border-radius: 14px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    border: 1px solid #eef2f7;
  }

  .funcao-titulo {
    font-size: 18px;
    font-weight: bold;
    color: var(--primary);
    margin-bottom: 12px;
    border-left: 6px solid var(--accent);
    padding-left: 10px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
  }

  .badge-count{
    background: rgba(11,94,215,0.10);
    color: var(--primary);
    border: 1px solid rgba(11,94,215,0.18);
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: bold;
    white-space: nowrap;
  }

  .pessoas {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  .pessoa {
    background: var(--chipBg);
    border: 1px solid var(--chipBorder);
    color: #053b4c;
    padding: 9px 12px;
    border-radius: 999px;
    font-weight: bold;
    font-size: 13px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    white-space: nowrap;
  }

  .vazio {
    color: var(--muted);
    font-style: italic;
    font-weight: bold;
  }

  /* ========= Modal Export ========= */
  .modal-backdrop{
    position: fixed;
    inset: 0;
    background: rgba(2,6,23,0.45);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 18px;
    z-index: 9999;
  }
  .modal{
    width: min(920px, 96vw);
    max-height: 88vh;
    overflow: auto;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.28);
    border: 1px solid rgba(255,255,255,0.35);
  }
  .modal-header{
    padding: 14px 16px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
    border-bottom: 1px solid #eef2f7;
    position: sticky;
    top: 0;
    background: #fff;
    z-index: 1;
  }
  .modal-title{
    display:flex;
    flex-direction:column;
    gap:2px;
  }
  .modal-title strong{
    font-size: 16px;
    color: var(--text);
  }
  .modal-title span{
    font-size: 12px;
    color: var(--muted);
    font-weight: bold;
  }
  .modal-actions{
    display:flex;
    gap: 10px;
    align-items:center;
  }
  .btn-secondary{
    background: #eef2f7;
    color: #0b2b45;
    box-shadow: none;
  }
  .btn-secondary:hover{
    background: #e6ebf3;
  }
  .btn-danger{
    background: #ef4444;
    color: #fff;
    box-shadow: none;
  }
  .btn-danger:hover{
    background: #dc2626;
  }
  .modal-body{
    padding: 18px;
    background: #fff;
  }

  /* ========= √Årea de impress√£o ========= */
  #printArea{
    display:none;
  }

  /* Impress√£o (PDF) */
  @media print {
    body{
      background: #fff !important;
      padding: 0 !important;
    }
    .topo-acoes, #status, #organograma, .modal-backdrop{
      display:none !important;
    }
    #printArea{
      display:block !important;
      padding: 18px !important;
    }
    .print-header{
      text-align:center;
      margin-bottom: 14px;
    }
    .print-header h2{
      margin: 0 0 6px 0;
      font-size: 20px;
      color: var(--text);
    }
    .print-header .print-sub{
      color: #555;
      font-weight: bold;
      font-size: 12px;
    }
    .funcao{
      box-shadow:none !important;
      border: 1px solid #e6e8ee !important;
      margin-bottom: 12px !important;
      page-break-inside: avoid;
    }
    .pessoa{
      box-shadow:none !important;
    }
  }
</style>
</head>

<body>

<h1>Organograma Funcional</h1>
<div id="status">Carregando dados‚Ä¶</div>

<div class="topo-acoes">
  <label>
    Filtrar por Posto/Gradua√ß√£o:
    <select id="filtroPosto">
      <option value="TODOS">Todos</option>
    </select>
  </label>

  <button onclick="abrirExport()">üìÑ Exportar PDF</button>
</div>

<div id="organograma"></div>

<!-- ===== Modal Export (Preview + A√ß√µes) ===== -->
<div class="modal-backdrop" id="exportModal">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="exportTitle">
    <div class="modal-header">
      <div class="modal-title">
        <strong id="exportTitle">Exportar PDF</strong>
        <span id="exportSubtitle">Preparando visualiza√ß√£o‚Ä¶</span>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" onclick="fecharExport()">Fechar</button>
        <button onclick="imprimirPDF()">Imprimir / Salvar PDF</button>
      </div>
    </div>
    <div class="modal-body">
      <div id="exportPreview"></div>
    </div>
  </div>
</div>

<!-- ===== √Årea real de impress√£o (oculta na tela) ===== -->
<div id="printArea">
  <div class="print-header">
    <h2>Organograma Funcional</h2>
    <div class="print-sub" id="printSubtitle"></div>
  </div>
  <div id="printContent"></div>
</div>

<script>
  /* ============================
     URL DO APPS SCRIPT (JSONP)
  ============================ */
  const BASE =
    "https://script.google.com/macros/s/AKfycbzfYOs-nwQrn28CKY_OR4FiXMb2SfF5skBHRsu_w_eNFxIHMBCofehTRPppUqf7pli3IQ/exec";

  const DATA_URL = BASE + "?mode=data&callback=cb&_=" + Date.now();
  let GLOBAL_DATA = null;

  /* ============================
     NORMALIZA TEXTO (evita mismatch)
  ============================ */
  function norm(t) {
    return String(t || "")
      .trim()
      .toUpperCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "");
  }

  /* ============================
     CALLBACK JSONP
  ============================ */
  function cb(payload) {
    const statusEl = document.getElementById("status");

    if (!payload || payload.error) {
      statusEl.innerHTML = "‚ùå Erro ao carregar dados" + (payload?.error ? `: ${payload.error}` : "");
      console.error("Payload inv√°lido:", payload);
      return;
    }

    GLOBAL_DATA = payload;

    const peopleCount = Array.isArray(payload.people) ? payload.people.length : 0;
    const hierCount = Array.isArray(payload.hierarchy) ? payload.hierarchy.length : 0;

    statusEl.innerHTML = `‚úì Organograma carregado (Pessoas: ${peopleCount} | Postos: ${hierCount})`;

    preencherFiltro(payload.people);
    montarTela(payload.hierarchy, payload.people);
  }

  /* ============================
     FILTRO
  ============================ */
  function preencherFiltro(people) {
    const select = document.getElementById("filtroPosto");
    select.innerHTML = `<option value="TODOS">Todos</option>`;

    const postos = [...new Set((people || []).map(p => norm(p.posto)).filter(Boolean))].sort();

    postos.forEach(postoNorm => {
      const option = document.createElement("option");
      option.value = postoNorm;
      option.textContent = postoNorm;
      select.appendChild(option);
    });

    select.onchange = aplicarFiltro;
  }

  function aplicarFiltro() {
    if (!GLOBAL_DATA) return;
    const filtro = document.getElementById("filtroPosto").value;
    let people = GLOBAL_DATA.people || [];

    if (filtro !== "TODOS") {
      people = people.filter(p => norm(p.posto) === filtro);
    }

    montarTela(GLOBAL_DATA.hierarchy || [], people);
  }

  /* ============================
     CORE: construir lista por posto
  ============================ */
  function buildPorPosto(hierarchy, people) {
    people = people || [];
    hierarchy = hierarchy || [];

    const peopleByPosto = new Map();
    people.forEach(p => {
      const key = norm(p.posto);
      if (!key) return;
      if (!peopleByPosto.has(key)) peopleByPosto.set(key, []);
      peopleByPosto.get(key).push({ ...p, _nomeKey: norm(p.nome) });
    });

    for (const [k, arr] of peopleByPosto.entries()) {
      arr.sort((a,b)=>a._nomeKey.localeCompare(b._nomeKey));
    }

    const postosDaHierarquia = hierarchy
      .map(h => norm(h.func)) // aqui "func" representa o POSTO
      .filter(Boolean);

    const postosFallback = Array.from(peopleByPosto.keys()).sort();
    const postosParaRender = postosDaHierarquia.length ? postosDaHierarquia : postosFallback;

    return { postosParaRender, peopleByPosto };
  }

  /* ============================
     Render (tela / preview / print)
  ============================ */
  function renderOrganograma(container, hierarchy, people, opts = {}) {
    const {
      tituloPrefixo = "POSTO/GRADUA√á√ÉO: ",
      mostrarVazios = true,
      contarPessoas = true
    } = opts;

    container.innerHTML = "";

    const { postosParaRender, peopleByPosto } = buildPorPosto(hierarchy, people);

    if (!postosParaRender.length) {
      container.innerHTML = `<div class="vazio">Nenhum dado para exibir.</div>`;
      return;
    }

    postosParaRender.forEach(postoKey => {
      const pessoas = peopleByPosto.get(postoKey) || [];

      if (!mostrarVazios && pessoas.length === 0) return;

      const bloco = document.createElement("div");
      bloco.className = "funcao";

      const titulo = document.createElement("div");
      titulo.className = "funcao-titulo";

      const left = document.createElement("div");
      left.textContent = tituloPrefixo + postoKey;

      titulo.appendChild(left);

      if (contarPessoas) {
        const badge = document.createElement("span");
        badge.className = "badge-count";
        badge.textContent = `${pessoas.length}`;
        titulo.appendChild(badge);
      }

      const pessoasDiv = document.createElement("div");
      pessoasDiv.className = "pessoas";

      if (pessoas.length === 0) {
        const vazio = document.createElement("div");
        vazio.className = "vazio";
        vazio.textContent = "Sem pessoas cadastradas";
        pessoasDiv.appendChild(vazio);
      } else {
        pessoas.forEach(p => {
          const card = document.createElement("div");
          card.className = "pessoa";
          card.textContent = `${p.posto} - ${p.nome}`;
          pessoasDiv.appendChild(card);
        });
      }

      bloco.appendChild(titulo);
      bloco.appendChild(pessoasDiv);
      container.appendChild(bloco);
    });
  }

  function montarTela(hierarchy, people) {
    const container = document.getElementById("organograma");
    renderOrganograma(container, hierarchy, people, {
      tituloPrefixo: "POSTO/GRADUA√á√ÉO: ",
      mostrarVazios: true,
      contarPessoas: true
    });
  }

  /* ============================
     EXPORT (no mesmo HTML)
  ============================ */
  function abrirExport() {
    if (!GLOBAL_DATA) return;

    const modal = document.getElementById("exportModal");
    const preview = document.getElementById("exportPreview");
    const sub = document.getElementById("exportSubtitle");
    const filtro = document.getElementById("filtroPosto").value;

    // Dados filtrados
    let people = GLOBAL_DATA.people || [];
    if (filtro !== "TODOS") {
      people = people.filter(p => norm(p.posto) === filtro);
      sub.textContent = `Pr√©-visualiza√ß√£o do PDF ‚Äî Filtro: ${filtro}`;
    } else {
      sub.textContent = `Pr√©-visualiza√ß√£o do PDF ‚Äî Todos os postos`;
    }

    // Preview mais "limpo" (sem vazios)
    renderOrganograma(preview, GLOBAL_DATA.hierarchy || [], people, {
      tituloPrefixo: "POSTO/GRADUA√á√ÉO: ",
      mostrarVazios: false,
      contarPessoas: true
    });

    // Prepara √°rea de impress√£o (o que vai pro PDF)
    const printSub = document.getElementById("printSubtitle");
    const printContent = document.getElementById("printContent");

    printSub.textContent = (filtro !== "TODOS")
      ? `Filtro: ${filtro}`
      : `Todos os postos`;

    renderOrganograma(printContent, GLOBAL_DATA.hierarchy || [], people, {
      tituloPrefixo: "POSTO/GRADUA√á√ÉO: ",
      mostrarVazios: false,
      contarPessoas: true
    });

    modal.style.display = "flex";
  }

  function fecharExport() {
    document.getElementById("exportModal").style.display = "none";
  }

  function imprimirPDF() {
    // d√° um tempinho pra garantir que o DOM do printArea est√° pronto
    setTimeout(() => window.print(), 250);
  }

  // Fecha modal clicando no fundo
  document.getElementById("exportModal").addEventListener("click", (e) => {
    if (e.target.id === "exportModal") fecharExport();
  });

  // Fecha com ESC
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") fecharExport();
  });

  /* ============================
     INJETAR JSONP
  ============================ */
  const s = document.createElement("script");
  s.src = DATA_URL;
  s.onerror = () => {
    document.getElementById("status").innerHTML =
      "‚ùå Erro ao carregar script de dados (verifique se o Web App est√° p√∫blico e a URL est√° correta).";
  };
  document.head.appendChild(s);
</script>

</body>
</html>
