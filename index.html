<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Organograma 1¬∫GBM do Corpo dos Bombeiros do Amap√°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: #f4f6f9;
    }

    h1 {
      color: #0b2b45;
      margin-bottom: 6px;
    }

    #status {
      font-weight: bold;
      margin-bottom: 15px;
    }

    .topo-acoes {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    select, button {
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }

    select {
      border: 1px solid #ccc;
    }

    button {
      background: #0b5ed7;
      color: #fff;
    }

    button:hover {
      background: #094bb0;
    }

    .funcao {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .funcao-titulo {
      font-size: 18px;
      font-weight: bold;
      color: #0b5ed7;
      margin-bottom: 14px;
      border-left: 6px solid #0dcaf0;
      padding-left: 10px;
    }

    .pessoas {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .pessoa {
      background: #0dcaf0;
      color: #053b4c;
      padding: 10px 14px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 13px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      white-space: nowrap;
    }

    .vazio {
      color: #777;
      font-style: italic;
      font-weight: bold;
    }
  </style>
</head>

<body>

  <h1>Organograma Funcional</h1>
  <div id="status">Carregando dados‚Ä¶</div>

  <div class="topo-acoes">
    <label>
      Filtrar por Posto/Gradua√ß√£o:
      <select id="filtroPosto">
        <option value="TODOS">Todos</option>
      </select>
    </label>

    <button onclick="exportarPDF()">üìÑ Exportar PDF</button>
  </div>

  <div id="organograma"></div>

  <script>
    /* ============================
       URL DO APPS SCRIPT (JSONP)
    ============================ */
    const BASE =
      "https://script.google.com/macros/s/AKfycbzfYOs-nwQrn28CKY_OR4FiXMb2SfF5skBHRsu_w_eNFxIHMBCofehTRPppUqf7pli3IQ/exec";

    const DATA_URL = BASE + "?mode=data&callback=cb&_=" + Date.now();
    let GLOBAL_DATA = null;

    /* ============================
       CALLBACK JSONP
    ============================ */
    function cb(payload) {
      if (!payload || payload.error) {
        document.getElementById("status").innerHTML =
          "‚ùå Erro ao carregar dados";
        return;
      }

      GLOBAL_DATA = payload;
      document.getElementById("status").innerHTML =
        "‚úì Organograma carregado";

      preencherFiltro(payload.people);
      montar(payload.hierarchy, payload.people);
    }

    /* ============================
       FILTRO
    ============================ */
    function preencherFiltro(people) {
      const select = document.getElementById("filtroPosto");
      const postos = [...new Set(people.map(p => p.posto))].sort();

      postos.forEach(posto => {
        const option = document.createElement("option");
        option.value = posto;
        option.textContent = posto;
        select.appendChild(option);
      });

      select.addEventListener("change", aplicarFiltro);
    }

    function aplicarFiltro() {
      const filtro = document.getElementById("filtroPosto").value;
      let people = GLOBAL_DATA.people;

      if (filtro !== "TODOS") {
        people = people.filter(p => p.posto === filtro);
      }

      montar(GLOBAL_DATA.hierarchy, people);
    }

    /* ============================
       MONTAR ORGANOGRAMA
    ============================ */
    function montar(hierarchy, people) {
      const container = document.getElementById("organograma");
      container.innerHTML = "";

      const filtro = document.getElementById("filtroPosto").value;

      hierarchy.forEach(h => {
        const pessoasFunc = people.filter(p => p.func === h.func);

        if (filtro !== "TODOS" && pessoasFunc.length === 0) return;

        const bloco = document.createElement("div");
        bloco.className = "funcao";

        const titulo = document.createElement("div");
        titulo.className = "funcao-titulo";
        titulo.textContent = "FUN√á√ÉO: " + h.func;

        const pessoasDiv = document.createElement("div");
        pessoasDiv.className = "pessoas";

        if (pessoasFunc.length === 0) {
          const vazio = document.createElement("div");
          vazio.className = "vazio";
          vazio.textContent = "Sem pessoas cadastradas";
          pessoasDiv.appendChild(vazio);
        } else {
          pessoasFunc.forEach(p => {
            const card = document.createElement("div");
            card.className = "pessoa";
            card.textContent = `${p.posto} - ${p.nome}`;
            pessoasDiv.appendChild(card);
          });
        }

        bloco.appendChild(titulo);
        bloco.appendChild(pessoasDiv);
        container.appendChild(bloco);
      });
    }

    /* ============================
       EXPORTAR PDF
    ============================ */
    function exportarPDF() {
      const filtro = document.getElementById("filtroPosto").value;
      let url = "export.html";

      if (filtro !== "TODOS") {
        url += "?posto=" + encodeURIComponent(filtro);
      }

      window.open(url, "_blank");
    }

    /* ============================
       INJETAR JSONP
    ============================ */
    const s = document.createElement("script");
    s.src = DATA_URL;
    s.onerror = () => {
      document.getElementById("status").innerHTML =
        "‚ùå Erro ao carregar script de dados";
    };
    document.head.appendChild(s);
  </script>

</body>
</html>
